---
layout: post
title:  "ESVIO代码详解"
info: "阅读ESVIO代码并解释核心功能"
tech: " 持续更新ing "
type: Brief introduction 
---

#### 整体逻辑: 

<table rules="none" align="center">
	<tr>
		<td>
			<center>
				<img src="https://effun.xyz/assets/img/20250117/rosgraph_esvio.png" width="100%" />
				<br/>
				<font color="AAAAAA"></font>
			</center>
		</td>
	</tr>
</table>

代码底层框架源于vins，包含三个独立的ros功能包：feature_tracker, esvio_estimator和pose_graph。

## &#127774;功能包1：feature_tacker

**包含event_detecor、feature_tracker、parameter、stereo_event_tracker_node、stereo_image_tracker_node五个核心文件。**

包含两个节点：stereo_image_tracker和stereo_event_tracker

### &#9889;1. stereo_image_tracker_node的main函数

从main函数分析关键函数的调用链：

```
int main(int argc, char **argv)
{
    ros::init(argc, argv, "stereo_image_tracker");
    ros::NodeHandle n("~");
    ros::console::set_logger_level(ROSCONSOLE_DEFAULT_NAME, ros::console::levels::Info);
    readParameters(n);

    // 初始化相机参数
    trackerData.stereo_readIntrinsicParameter(CAM_NAMES);

    // 订阅左右相机图像
    ros::Subscriber sub_img_left = n.subscribe(IMAGE_LEFT, 100, img_callback_left);
    ros::Subscriber sub_img_right = n.subscribe(IMAGE_RIGHT, 100, img_callback_right);

    // 发布特征点和可视化信息
    pub_img = n.advertise<sensor_msgs::PointCloud>("feature", 1000);
    pub_match = n.advertise<sensor_msgs::Image>("feature_img",1000);
    pub_restart = n.advertise<std_msgs::Bool>("restart",1000);

    // 启动同步线程
    std::thread sync_thread{sync_process};
    ros::spin();
    return 0;
}

```

关键函数调用链：

* readParameters(n) → 读取配置文件 → 初始化全局参数

* trackerData.stereo_readIntrinsicParameter(CAM_NAMES) → 读取相机内参

* std::thread sync_thread{sync_process} → 启动同步线程

* sync_process() → 同步左右相机图像

* getImageFromMsg() → 转换ROS图像消息为OpenCV格式

* handle_stereo_image() → 处理立体图像

* trackerData.trackImage() → 特征跟踪核心函数


### &#9889;2. stereo_event_tracker_node的main函数

基本同上

### &#9889;3. handle_stereo_event函数

首先说明，对于事件队列：

`这是左右相机事件的定义：queue<dvs_msgs::EventArray> events_left_buf;`


队列（queue）：这是C++标准库中的一个容器适配器，实现了FIFO（先进先出）的数据结构。主要操作有：

    push：添加元素到队尾
    pop：移除队首元素
    front：访问队首元素
    empty：检查队列是否为空




dvs_msgs::EventArray：这是一个ROS消息类型，用于存储事件相机捕获的事件数据。从你提供的头文件可以看出它包含以下字段：

    header：标准ROS消息头，包含时间戳和坐标帧ID
    height：图像高度（行数）
    width：图像宽度（列数）
    events：事件数组，类型为Event[]



Event 结构：根据定义，每个Event包含：

    x：事件在图像上的x坐标（列）
    y：事件在图像上的y坐标（行）
    ts：事件的时间戳
    polarity：事件的极性（true或false，表示亮度增加或减少）

所以，queue<dvs_msgs::EventArray> events_left_buf 是一个队列，用于存储来自左相机的事件数据包。每个数据包（EventArray）包含在特定时间窗口内捕获的一系列事件。

在sync_process函数中，每次循环只处理队列中的一个dvs_msgs::EventArray消息